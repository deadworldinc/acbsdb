<!DOCTYPE html>
<html lang="ru">

<head>
	<title>База данных оборудования ЦБС</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdfmake@latest/build/pdfmake.min.js "></script> 
	<script src="https://cdn.jsdelivr.net/npm/pdfmake@latest/build/vfs_fonts.min.js"></script> 
	<script src="https://cdn.jsdelivr.net/npm/html-to-pdfmake/browser.js"></script> 
	<script src="/database/sorttable.js"></script>
	<meta name="viewport" content="width=device-width, initial-scale=1" />
</head>

<body style="display: flex; justify-content: start; flex-direction: column;">
    <div class="right-header" style="padding: 12px; position: relative;">
        <div style="position: absolute; left: 15px; opacity: 0.75; padding: 7px 15px; background-color: rgb(245, 245, 245); border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 8px;">
            <div style="display: flex; align-items: center;">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-house-icon lucide-house"><path d="M15 21v-8a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v8"/><path d="M3 10a2 2 0 0 1 .709-1.528l7-5.999a2 2 0 0 1 2.582 0l7 5.999A2 2 0 0 1 21 10v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>
                <span class="default-text" style="margin-left: 5px;">acbsdb.ru</span>
                <svg width="10" height="10" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10" style="opacity: 0.5; margin-inline: 10px;">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 9 4-4-4-4"/>
                </svg>
                <span class="default-text">database</span>
                <svg width="10" height="10" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10" style="opacity: 0.5; margin-inline: 10px;">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 9 4-4-4-4"/>
                </svg>
                <span class="default-text">public</span>
                <svg width="10" height="10" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10" style="opacity: 0.5; margin-inline: 10px;">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 9 4-4-4-4"/>
                </svg>
                <span class="default-text">equipment</span>
            </div>
		</div>
        <div class="search-field-container">
            <input id="inputSearchByBranch" class="search-input" placeholder="Поиск по филиалу" autocomplete="off">
            <div id="buttonSearchByBranch" class="button-search">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 26 26" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search-icon lucide-search"><path d="m21 21-4.34-4.34"/><circle cx="11" cy="11" r="8"/></svg>
            </div>
        </div>
        <div class="search-field-container">
            <input id="inputSearchByName" class="search-input" placeholder="Поиск по наименованию" autocomplete="off">
            <div id="buttonSearchByName" class="button-search">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 26 26" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search-icon lucide-search"><path d="m21 21-4.34-4.34"/><circle cx="11" cy="11" r="8"/></svg>
            </div>
        </div>
        <div class="search-field-container">
            <input id="inputSearchByInventoryNumber" class="search-input" placeholder="Поиск по инв. номеру" autocomplete="off">
            <div id="buttonSearchByInventoryNumber" class="button-search">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 26 26" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search-icon lucide-search"><path d="m21 21-4.34-4.34"/><circle cx="11" cy="11" r="8"/></svg>
            </div>
        </div>
        <div id="buttonExportXLSX" class="button-export" style="width: 34px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 26 26" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-table2-icon lucide-table-2" style="opacity: 0.75;"><path d="M9 3H5a2 2 0 0 0-2 2v4m6-6h10a2 2 0 0 1 2 2v4M9 3v18m0 0h10a2 2 0 0 0 2-2V9M9 21H5a2 2 0 0 1-2-2V9m0 0h18"/></svg>
        </div>
        <div id="buttonExportPDF" class="button-export" style="width: 34px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 26 26" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text-icon lucide-file-text" style="opacity: 0.75;"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>
        </div>
        <div id="buttonPrintPDF" class="button-export" style="width: 34px; margin-right: 5px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 26 26" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-printer-icon lucide-printer" style="opacity: 0.75;"><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><path d="M6 9V3a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v6"/><rect x="6" y="14" width="12" height="8" rx="1"/></svg>
        </div>
    </div>
    <div id="rightMainContainer" style="width: 100%; overflow-y: scroll;">
        <table id="mainTable" class="main-table sortable">
            <thead>
                <tr class="table-header">
                    <td class="table-header-title">ID</td>
                    <td class="table-header-title">Филиал</td>
                    <td class="table-header-title">Ответственное лицо</td>
                    <td class="table-header-title">Наименование</td>
                    <td class="table-header-title">Инв. номер</td>
                    <td class="table-header-title">Сумма</td>
                    <td class="table-header-title">Количество</td>
                </tr>
            </thead>
            <tr id="tableRow"></tr>
        </table>
    </div>
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        import * as XLSX from 'https://unpkg.com/xlsx/xlsx.mjs';

        const supabase = createClient('https://hlapzydzkeyttgmughiu.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhsYXB6eWR6a2V5dHRnbXVnaGl1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjkxNDc4NzAsImV4cCI6MjA0NDcyMzg3MH0.fNlhkzfU5RZURQpfu1sTz4EjWL-ImWRvGNx0mMBwuE8');
        let conversion;
        let docDefinition;

        const { data, error } = await supabase
        .from('equipment')
        .select()
        .order('id', { ascending: true })
        let receivedData = JSON.parse(JSON.stringify(data));

        async function getData(isSearch, searchColumn, searchValue) {
            let tableRow = document.getElementById("tableRow");

            let tableRows = document.getElementsByClassName("table-rows");
            while(tableRows[0]) {
                tableRows[0].parentNode.removeChild(tableRows[0]);
            }

            let receivedData;

            if (!isSearch) {
                const { data, error } = await supabase
                .from('equipment')
                .select()
                .order('id', { ascending: true })
                receivedData = JSON.parse(JSON.stringify(data));
            } else {
                const { data, error } = await supabase
                .from('equipment')
                .select()
                .order('id', { ascending: true })
                .ilike(`${searchColumn}`, `${searchValue}`);
                receivedData = JSON.parse(JSON.stringify(data));
            }

            for (let entry in receivedData) {
                tableRow.insertAdjacentHTML('beforeBegin', 
                    `
                    <tr class="table-rows">
                        <td class="main-table-cell">${receivedData[entry].id}</td>
                        <td class="main-table-cell">${receivedData[entry].branch}</td>
                        <td class="main-table-cell">${receivedData[entry].responsible_person}</td>
                        <td class="main-table-cell">${receivedData[entry].name}</td>
                        <td class="main-table-cell">${receivedData[entry].inventory_number}</td>
                        <td class="main-table-cell">${receivedData[entry].amount} руб.</td>
                        <td class="main-table-cell">${receivedData[entry].quantity} шт.</td>
                    </tr>
                    `);
            }

            let tableEntries = document.querySelectorAll(".main-table-cell");
            for (let i = 0; i < tableEntries.length; i++) {
                let tableEntry = tableEntries[i];
                tableEntry.ondblclick = function() {
                    console.log(tableEntry.parentElement.getElementsByClassName("main-table-cell")[0].textContent);
                }        
            }
        }

        function generatePDF() {
            conversion = htmlToPdfmake(
            `
                <div> 
                    <p style="text-align: center; font-size: 18px;"><strong>Муниципальное бюджетное учреждение города Абакана<br>«Абаканская централизованная библиотечная система»</strong></p>
                    <span style="font-size: 14px;">
                        Отчет, содержащий сведения о компьютерном оборудовании библиотек-филиалов Абаканской централизованной библиотечной системы.
                        <br><br>Отчет составлен <span style="font-weight: bold;">${new Date().toLocaleDateString()}</span> в 
                        <span style="font-weight: bold;">${new Date().toLocaleTimeString('en-GB', { hour: "numeric", minute: "numeric"})}</span>
                        на основе информации, содержащейся в базе данных оборудования ЦБС.
                    </span>
                    ${document.getElementById("rightMainContainer").getHTML()
                        .replaceAll('<span class="sorttable-label" id="sorttable_sortrevind">ASC</span>', '')
                        .replaceAll('<span class="sorttable-label" id="sorttable_sortfwdind">DESC</span>', '')
                        .replaceAll('class="main-table-cell"', 'class="main-table-cell" style="padding: 5px; font-size: 14px; text-align: center; vertical-align: baseline;"')
                        .replaceAll('class="table-header-title"', 'class="table-header-title" style="background-color: #f5f5f5; padding: 5px; font-size: 14px; text-align: center; vertical-align: baseline;"')
                        .replaceAll('class="table-header-title sorttable_sorted"', 'class="table-header-title" style="background-color: #f5f5f5; padding: 5px; font-size: 14px; text-align: center; vertical-align: baseline;"')
                        .replaceAll('class="table-header-title sorttable_sorted_reverse"', 'class="table-header-title" style="background-color: #f5f5f5; padding: 5px; font-size: 14px; text-align: center; vertical-align: baseline;"')
                    }
                    <span style="font-size: 10px; text-align: center;">
                        acbsdb.ru • ${new Date().toLocaleDateString()} • ${new Date().toLocaleTimeString('en-GB', { hour: "numeric", minute: "numeric"})}
                    </span> 
                </div> 
            `);
            docDefinition = { 
                pageOrientation: "landscape",
                footer: (currentPage, pageCount) => {
                    var t = {
                        layout: "noBorders",
                        fontSize: 10,
                        margin: [375, 0, 0, 0],
                        table: {
                        body: [
                            [
                            { text: "Страница " + currentPage.toString() + " из " + pageCount },
                            ]
                        ]
                        }
                    };
                    return t;
                },
                content : conversion 
            };
        }

        let inputSearchByBranch = document.getElementById("inputSearchByBranch");
        let buttonSearchByBranch = document.getElementById("buttonSearchByBranch");
        let inputSearchByName = document.getElementById("inputSearchByName");
        let buttonSearchByName = document.getElementById("buttonSearchByName");
        let inputSearchByInventoryNumber = document.getElementById("inputSearchByInventoryNumber");
        let buttonSearchByInventoryNumber = document.getElementById("buttonSearchByInventoryNumber");
        let buttonExportXLSX = document.getElementById("buttonExportXLSX");
        let buttonExportPDF = document.getElementById("buttonExportPDF");
        let buttonPrintPDF = document.getElementById("buttonPrintPDF");

        getData(false);

        buttonSearchByBranch.onclick = function() {
            if (inputSearchByBranch.value != "") {
                getData(true, 'branch', `%${inputSearchByBranch.value}%`);
            }
            else {
                getData(false);
            }
        }

        buttonSearchByName.onclick = function() {
            if (inputSearchByName.value != "") {
                getData(true, 'name', `%${inputSearchByName.value}%`);
            }
            else {
                getData(false);
            }
        }

        buttonSearchByInventoryNumber.onclick = function() {
            if (inputSearchByInventoryNumber.value != "") {
                getData(true, 'inventory_number', `%${inputSearchByInventoryNumber.value}%`);
            }
            else {
                getData(false);
            }
        }

        buttonExportXLSX.onclick = async function() {
            let receivedData;

            const { data, error } = await supabase
            .from('equipment')
            .select()
            .csv();
            receivedData = data;

            let csv_string = receivedData.toString()
                .replace("id", "ID")
                .replace("branch", "Филиал")
                .replace("name", "Наименование")
                .replace("inventory_number", "Инв. номер")
                .replace("responsible_person", "Отв. лицо")
                .replace("amount", "Сумма")
                .replace("quantity", "Кол-во");
            let xlsxFile = XLSX.read(csv_string, { type: "string" });
            XLSX.writeFileXLSX(xlsxFile, "Equipment.xlsx");
        }

        buttonExportPDF.onclick = function() {
            generatePDF();
            pdfMake.createPdf(docDefinition).download('Equipment.pdf');
        }

        buttonPrintPDF.onclick = function() {
            generatePDF();
            pdfMake.createPdf(docDefinition).print();
        }
   </script>
</body>